- name: Check NVIDIA GPU status
  command: nvidia-smi
  register: nvidia_smi_output
  ignore_errors: yes

- name: Print NVIDIA GPU status
  debug:
    msg: "{{ nvidia_smi_output.stdout_lines }}"

- name: Check if NVIDIA GPU is available
  fail:
    msg: "No NVIDIA GPU detected"
  when: nvidia_smi_output.rc != 0

- name: Setting Up the repositories and keyrings
  shell: |
    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
    && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
  args:
    warn: false

- name: Update apt packages
  apt:
    upgrade: yes
    update_cache: yes
    force_apt_get: yes

- name: Install NVIDIA Container Runtime
  apt:
    name: nvidia-container-runtime
    state: present
    update_cache: yes

- name: Reload Docker service
  systemd:
    name: docker
    state: restarted
    daemon_reload: yes


