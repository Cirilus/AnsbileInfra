---
- name: Validate certbot input variables
  ansible.builtin.assert:
    that:
      - email | length > 0
      - domain_name | length > 0
    fail_msg: "Set both email and domain_name for certbot role."

- name: Install certbot packages
  ansible.builtin.apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present
    update_cache: true
    cache_valid_time: 3600
  become: true

- name: Create certificate only if it does not exist
  ansible.builtin.command:
    argv:
      - certbot
      - certonly
      - --non-interactive
      - --agree-tos
      - --nginx
      - --email
      - "{{ email }}"
      - -d
      - "{{ domain_name }}"
  args:
    creates: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
  become: true
